<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survival V: Complete Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;800&family=Creepster&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Base Settings */
        body { margin: 0; overflow: hidden; font-family: 'Kanit', sans-serif; background: #050505; user-select: none; -webkit-user-select: none; touch-action: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI Layers */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(10, 10, 15, 0.98); color: #ddd; transition: opacity 0.5s;
        }
        .hidden { display: none !important; }

        h1 { font-family: 'Creepster', cursive; color: #d32f2f; font-size: 4rem; margin: 0; text-shadow: 0 0 20px #ff0000; letter-spacing: 5px; }
        
        /* Menu Styles */
        .role-selector { display: flex; gap: 20px; margin: 20px; }
        .role-card {
            width: 150px; padding: 20px; background: #222; border: 2px solid #555; cursor: pointer;
            text-align: center; border-radius: 10px; transition: 0.3s;
        }
        .role-card:hover { transform: scale(1.05); }
        .role-card.selected { border-color: gold; background: #443300; box-shadow: 0 0 15px gold; }
        .role-card.hunter-role.selected { border-color: red; background: #440000; box-shadow: 0 0 15px red; }

        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .char-btn { padding: 10px; background: #333; border: 1px solid #555; color: #aaa; cursor: pointer; }
        .char-btn.selected { background: #eee; color: #000; font-weight: bold; }

        button.start-btn {
            background: #d32f2f; border: none; padding: 15px 50px; font-size: 2rem;
            color: white; font-family: 'Creepster'; border-radius: 5px; cursor: pointer;
            box-shadow: 0 0 20px #ff0000; margin-top: 30px; letter-spacing: 2px;
        }

        /* HUD Styles */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; display: none; }
        
        #minimap-container {
            position: absolute; top: 20px; left: 20px; width: 130px; height: 130px;
            background: rgba(0, 0, 0, 0.85); border: 2px solid #666; border-radius: 8px;
            overflow: hidden; box-shadow: 0 0 10px black;
        }
        .mm-dot { position: absolute; width: 8px; height: 8px; border-radius: 50%; transform: translate(-50%, -50%); transition: top 0.1s, left 0.1s; }
        #mm-player { background: #00ff00; z-index: 12; border: 2px solid white; display: flex; justify-content: center; align-items: center; }
        .mm-arrow { width: 0; height: 0; border-left: 3px solid transparent; border-right: 3px solid transparent; border-bottom: 6px solid black; transform: translateY(-2px); }
        .mm-hunter { background: #ff0000; z-index: 10; box-shadow: 0 0 6px red; width: 10px; height: 10px; }
        .mm-survivor { background: #00ffff; z-index: 9; border: 1px solid blue; }
        
        #health-display { position: absolute; top: 160px; left: 20px; font-size: 30px; color: #ff4444; text-shadow: 0 0 5px black; }

        .status-area { position: absolute; top: 20px; right: 20px; text-align: right; }
        #stamina-bar-bg { width: 220px; height: 12px; background: #222; border: 1px solid #555; margin-bottom: 5px; display: inline-block; border-radius: 6px; overflow: hidden; }
        #stamina-bar { width: 100%; height: 100%; background: #4caf50; transition: width 0.1s; }

        .action-prompt {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9); color: black; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; font-size: 1.5rem; display: none; text-shadow: 0 0 5px white; box-shadow: 0 0 15px gold;
        }

        .pc-hint {
            position: absolute; bottom: 20px; right: 20px; 
            background: rgba(0,0,0,0.5); color: #aaa; padding: 10px; border-radius: 5px; font-size: 0.8rem; text-align: right;
        }

        /* --- MOBILE CONTROLS --- */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .touch-zone { pointer-events: auto; position: absolute; }

        #joystick-area {
            bottom: 30px; left: 30px; width: 160px; height: 160px;
            background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
        }
        #joystick-knob {
            position: absolute; top: 50%; left: 50%; width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.4); border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #action-area {
            bottom: 30px; right: 30px;
            display: grid; grid-template-columns: 80px 100px; grid-template-rows: 80px 100px; gap: 15px;
            align-items: end; justify-items: center;
        }
        .mob-btn {
            background: rgba(0,0,0,0.6); border: 2px solid #ccc; border-radius: 50%;
            color: white; display: flex; justify-content: center; align-items: center;
            user-select: none; transition: 0.1s; font-size: 24px; pointer-events: auto;
            backdrop-filter: blur(4px);
        }
        .mob-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        
        #btn-main { width: 100px; height: 100px; font-size: 45px; border-color: #ffca28; grid-column: 2; grid-row: 2; }
        #btn-main.hunter-atk { border-color: #ff4444; background: rgba(200, 50, 50, 0.3); }
        
        #btn-interact { 
            width: 80px; height: 80px; font-size: 30px; border-color: #03a9f4; 
            grid-column: 2; grid-row: 1; opacity: 0.3; transform: scale(0.8); transition: 0.2s; 
        }
        #btn-interact.active { opacity: 1; transform: scale(1); box-shadow: 0 0 15px #03a9f4; background: rgba(3, 169, 244, 0.3); }
        
        #btn-skill { width: 70px; height: 70px; grid-column: 1; grid-row: 2; margin-bottom: 10px; font-size: 20px; }
        #btn-run { width: 60px; height: 60px; grid-column: 1; grid-row: 1; font-size: 20px; }
        #btn-run.active { background: #4caf50; border-color: #81c784; }

        #btn-fs {
            position: absolute; top: 10px; right: 10px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border: 1px solid white; border-radius: 5px;
            color: white; font-size: 20px; display: flex; justify-content: center; align-items: center;
            pointer-events: auto; z-index: 30; cursor: pointer;
        }

        #look-zone { position: absolute; top: 0; right: 0; width: 60%; height: 100%; pointer-events: auto; }

        @media (hover: none) and (pointer: coarse) {
            #mobile-controls { display: block; }
            .pc-hint { display: none; }
        }
        
        /* Overlays */
        #blood-overlay, #flash-overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; opacity: 0; transition: 0.1s; z-index: 15; }
        #blood-overlay { background: radial-gradient(circle, transparent 50%, rgba(150,0,0,0.8) 100%); transition: 0.5s; }
        #flash-overlay { background: white; }
        
        #recover-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff4444; font-size: 2rem; font-weight: bold; text-shadow: 2px 2px 0 black;
            display: none; z-index: 16;
        }
    </style>
</head>
<body>

    <div id="game-container"></div>
    <div id="blood-overlay"></div>
    <div id="flash-overlay"></div>
    <div id="recover-msg">‡πÄ‡∏ä‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î... (Recovering)</div>

    <!-- MAIN MENU -->
    <div id="menu" class="ui-layer">
        <h1>Survival V</h1>
        <div class="role-selector">
            <div class="role-card selected" onclick="selectRole('survivor', this)">
                <div style="font-size:3rem">üèÉ</div>
                <h3>‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h3>
                <small>‡∏´‡∏ô‡∏µ‡∏ï‡∏≤‡∏¢ (2 HP)</small>
            </div>
            <div class="role-card hunter-role" onclick="selectRole('hunter', this)">
                <div style="font-size:3rem">üë∫</div>
                <h3>‡∏ú‡∏π‡πâ‡∏•‡πà‡∏≤</h3>
                <small>‡πÑ‡∏•‡πà‡∏•‡πà‡∏≤ (Attack)</small>
            </div>
        </div>
        <div class="char-grid" id="char-options"></div>
        <button class="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div id="mobile-controls">
            <div id="btn-fs" onclick="toggleFullscreen()">‚õ∂</div>
            <div id="joystick-area" class="touch-zone"><div id="joystick-knob"></div></div>
            <div id="look-zone"></div>
            
            <div id="action-area" class="touch-zone">
                <div class="mob-btn" id="btn-interact">üñêÔ∏è</div> <!-- Context: Vault/Drop -->
                <div class="mob-btn" id="btn-main"></div> <!-- Attack or Main Action -->
                <div class="mob-btn" id="btn-skill">‚ö°</div>
                <div class="mob-btn" id="btn-run">üèÉ</div>
            </div>
        </div>

        <div id="minimap-container">
            <div id="mm-player" class="mm-dot"><div class="mm-arrow"></div></div>
        </div>
        <div id="health-display">‚ù§Ô∏è‚ù§Ô∏è</div> 
        
        <div class="status-area">
            <div style="color:white; font-size: 2rem; font-weight:bold;" id="timer">120</div>
            <div id="stamina-bar-bg"><div id="stamina-bar"></div></div>
            <div style="color:#aaa; font-size: 0.8rem;">Skill: <span id="skill-name"></span> <span id="skill-status"></span></div>
        </div>
        
        <div class="action-prompt" id="interaction-msg">SPACE</div>
        <div class="pc-hint">
            [CTRL] ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå<br>[W A S D] ‡πÄ‡∏î‡∏¥‡∏ô<br>[SPACE] ‡∏Ç‡πâ‡∏≤‡∏°/‡∏û‡∏±‡∏ö‡πÑ‡∏°‡πâ<br>[L-Click] ‡πÇ‡∏à‡∏°‡∏ï‡∏µ/‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="game-over" class="ui-layer hidden">
        <h1 id="go-title">...</h1>
        <button class="start-btn" onclick="location.reload()">MAIN MENU</button>
    </div>

    <script>
        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'hit') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.2);
                gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
                osc.start(); osc.stop(now+0.2);
            } else if (type === 'action') {
                osc.type = 'square'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now+0.1);
                gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
                osc.start(); osc.stop(now+0.2);
            } else if (type === 'pallet') {
                osc.type = 'square'; osc.frequency.setValueAtTime(80, now); osc.frequency.exponentialRampToValueAtTime(20, now+0.2);
                gain.gain.setValueAtTime(0.6, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
                osc.start(); osc.stop(now+0.2);
            } else if (type === 'heartbeat') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(60, now); osc.frequency.exponentialRampToValueAtTime(40, now+0.1);
                gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                osc.start(); osc.stop(now+0.15);
            }
        }

        // --- STATE ---
        const config = { role: 'survivor', char: 'mercenary' };
        const state = { playing: false, time: 120, stamina: 100, skillCd: 0, speedBuff: 1.0, isVaulting: false, isAttacking: false, isRecovering: false, lastTime: 0 };
        const touchInput = { x: 0, y: 0, run: false };
        let joyTouchId = null, lookTouchId = null, lastLookX = 0;

        let scene, camera, renderer, player;
        let aiAgents = [], walls = [], pallets = [], windows = [], particles = [];
        let keys = {};

        // --- INIT ---
        function init() {
            updateCharOptions();
            const container = document.getElementById('game-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x151525);
            scene.fog = new THREE.Fog(0x151525, 10, 60);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const moon = new THREE.DirectionalLight(0xaaccff, 0.7);
            moon.position.set(30, 50, 30); moon.castShadow = true; scene.add(moon);

            window.addEventListener('resize', onResize);
            window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space') tryInteract(); if(e.code==='KeyE') useSkill(); });
            window.addEventListener('keyup', e => keys[e.code] = false);
            
            // Mouse Look (PC)
            document.addEventListener('mousemove', e => {
                if(state.playing && document.pointerLockElement && !state.isVaulting) {
                    player.rotation.y -= e.movementX * 0.003;
                }
            });
            document.addEventListener('click', () => {
                // Lock only if not mobile
                if(state.playing && !document.pointerLockElement && window.innerWidth > 768) container.requestPointerLock();
                if(state.playing && config.role === 'hunter' && window.innerWidth > 768) attack();
            });

            initMobileControls();
            requestAnimationFrame(animate);
        }

        // --- MOBILE INPUT ---
        function initMobileControls() {
            const joyArea = document.getElementById('joystick-area');
            const joyKnob = document.getElementById('joystick-knob');
            const lookZone = document.getElementById('look-zone');

            // Joystick (Multitouch safe)
            joyArea.addEventListener('touchstart', e => { e.preventDefault(); joyTouchId = e.changedTouches[0].identifier; handleJoy(e.changedTouches[0], joyArea, joyKnob); });
            joyArea.addEventListener('touchmove', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++) if(e.changedTouches[i].identifier === joyTouchId) handleJoy(e.changedTouches[i], joyArea, joyKnob); });
            joyArea.addEventListener('touchend', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++) if(e.changedTouches[i].identifier === joyTouchId) { joyTouchId = null; resetJoy(joyKnob); } });

            // Look (High Sensitivity)
            lookZone.addEventListener('touchstart', e => { e.preventDefault(); lookTouchId = e.changedTouches[0].identifier; lastLookX = e.changedTouches[0].clientX; });
            lookZone.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let i=0; i<e.changedTouches.length; i++) {
                    if(e.changedTouches[i].identifier === lookTouchId) {
                        const dx = e.changedTouches[i].clientX - lastLookX;
                        lastLookX = e.changedTouches[i].clientX;
                        if(state.playing && !state.isVaulting) player.rotation.y -= dx * 0.02; // Increased sensitivity
                    }
                }
            });
            lookZone.addEventListener('touchend', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++) if(e.changedTouches[i].identifier === lookTouchId) lookTouchId = null; });

            // Buttons
            const bind = (id, fn) => document.getElementById(id).addEventListener('touchstart', e => { e.preventDefault(); e.stopPropagation(); fn(); });
            bind('btn-main', () => { if(config.role==='hunter') attack(); else tryInteract(); });
            bind('btn-interact', tryInteract);
            bind('btn-skill', useSkill);
            bind('btn-run', () => { 
                touchInput.run = !touchInput.run; 
                document.getElementById('btn-run').classList.toggle('active', touchInput.run); 
            });
        }

        function handleJoy(touch, area, knob) {
            const rect = area.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            let dx = touch.clientX - cx; let dy = touch.clientY - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const max = rect.width/2;
            if (dist > max) { dx = (dx/dist)*max; dy = (dy/dist)*max; }
            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            touchInput.x = dx / max; touchInput.y = dy / max;
        }
        function resetJoy(knob) { knob.style.transform = `translate(-50%, -50%)`; touchInput.x = 0; touchInput.y = 0; }

        // --- GAMEPLAY ---
        function startGame() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('hud').style.display = 'block';
            
            // Configure Mobile Buttons
            const mainBtn = document.getElementById('btn-main');
            if(config.role === 'survivor') {
                mainBtn.innerText = 'üèÉ'; // Default action is run? No, interact mainly
                mainBtn.style.display = 'none'; // Survivor main action is interact (separate button)
            } else {
                mainBtn.innerText = '‚öîÔ∏è'; 
                mainBtn.classList.add('hunter-atk');
                mainBtn.style.display = 'flex';
            }

            while(scene.children.length > 0) scene.remove(scene.children[0]);
            particles = [];
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const moon = new THREE.DirectionalLight(0xaaccff, 0.8);
            moon.position.set(30, 50, 30); moon.castShadow = true; scene.add(moon);

            createMap();
            spawnCharacters();
            
            state.playing = true; state.time = 120; state.stamina = 100; state.speedBuff = 1.0;
            state.isRecovering = false; state.isAttacking = false; state.isVaulting = false;
            updateHealthUI();
            
            const names = {'mercenary':'Dash', 'doctor':'Heal', 'thief':'Flash', 'ripper':'Speed', 'clown':'Charge'};
            document.getElementById('skill-name').innerText = names[config.char] || 'Skill';
        }

        // --- OBJECTS ---
        function createMap() {
            walls = []; pallets = []; windows = [];
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(120, 120), new THREE.MeshStandardMaterial({ color: 0x333344 }));
            floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true; scene.add(floor);

            const mapStr = [
                "111111111111111", "100000000000001", "101110101111101", "100000100000001", "111P101W1111101",
                "100000000000001", "101111101P11101", "100000001000001", "1011W1101011101", "100000100000001",
                "11111011101P111", "100000000000001", "111111111111111"
            ];
            const u = 6;
            const wMat = new THREE.MeshStandardMaterial({ color: 0x555566 });
            
            for(let z=0; z<mapStr.length; z++) {
                for(let x=0; x<mapStr[z].length; x++) {
                    const c = mapStr[z][x];
                    const px = (x-7)*u, pz = (z-6)*u;
                    if(c==='1') {
                        const w = new THREE.Mesh(new THREE.BoxGeometry(u,6,u), wMat);
                        w.position.set(px,3,pz); scene.add(w); walls.push(w);
                    } else if(c==='P') {
                        const p = new THREE.Mesh(new THREE.BoxGeometry(1.2,4,3), new THREE.MeshStandardMaterial({color:0x8d6e63}));
                        p.position.set(px,2,pz); p.userData={isPallet:true,dropped:false}; scene.add(p); pallets.push(p);
                        const sw = new THREE.Mesh(new THREE.BoxGeometry(u/3,6,u/3), wMat);
                        sw.position.set(px-u/2.5,3,pz); scene.add(sw); walls.push(sw);
                        const sw2 = sw.clone(); sw2.position.set(px+u/2.5,3,pz); scene.add(sw2); walls.push(sw2);
                    } else if(c==='W') {
                        const wb = new THREE.Mesh(new THREE.BoxGeometry(u,2,u/2), wMat);
                        wb.position.set(px,1,pz); scene.add(wb); walls.push(wb);
                        windows.push({position: new THREE.Vector3(px,1,pz)});
                    }
                }
            }
        }

        function createChar(col, scl, isH) {
            const g = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: col, emissive: isH?0x000000:0x004400, emissiveIntensity:0.5 });
            const b = new THREE.Mesh(new THREE.BoxGeometry(1,2,0.6), mat); b.position.y=1; g.add(b);
            const h = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6), new THREE.MeshStandardMaterial({color:0xffccaa})); h.position.y=2.4; g.add(h);
            g.scale.set(scl,scl,scl);
            g.userData = { hp:2, invul:0, recovery:0, lastPos:new THREE.Vector3(), stuckTime:0 };
            
            if(isH) {
                const l = new THREE.SpotLight(0xff0000, 5, 20, Math.PI/4, 0.5);
                l.position.set(0,3,0.5); l.target.position.set(0,0,10); g.add(l); g.add(l.target);
            }
            return g;
        }

        function spawnCharacters() {
            aiAgents = [];
            const mmC = document.getElementById('minimap-container');
            mmC.querySelectorAll('.mm-dot:not(#mm-player)').forEach(d => d.remove());

            if(config.role === 'survivor') {
                player = createChar(0x00ff00, 0.8, false); setSafePos(player, 0, 30);
                const hunter = createChar(0xff0000, 1.2, true); setSafePos(hunter, 0, -30);
                Object.assign(hunter.userData, {role:'hunter', speed:12, aiAction:0});
                scene.add(hunter); aiAgents.push(hunter); addMMDot(hunter, 'mm-hunter');
            } else {
                player = createChar(0xff0000, 1.2, true); setSafePos(player, 0, -30);
                for(let i=0; i<3; i++) {
                    const s = createChar(0x00ff00, 0.8, false); setSafePos(s, (Math.random()-0.5)*40, (Math.random()-0.5)*40);
                    Object.assign(s.userData, {role:'survivor', speed:9.5, wander:new THREE.Vector3(), aiAction:0});
                    scene.add(s); aiAgents.push(s); addMMDot(s, 'mm-survivor');
                }
            }
            scene.add(player);
        }

        function setSafePos(agent, x, z) {
            agent.position.set(x,0,z);
            let n=0; while(checkCol(agent.position, agent.userData.role==='hunter') && n<200) {
                agent.position.x = (Math.random()-0.5)*80; agent.position.z = (Math.random()-0.5)*80; n++;
            }
        }

        function addMMDot(agent, cls) {
            const d = document.createElement('div'); d.className = `mm-dot ${cls}`;
            document.getElementById('minimap-container').appendChild(d);
            agent.userData.dot = d;
        }

        function checkCol(pos, isH) {
            const r = isH ? 0.7 : 0.4;
            const pb = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(pos.x, 1, pos.z), new THREE.Vector3(r*2, 2, r*2));
            for(let w of walls) if(pb.intersectsBox(new THREE.Box3().setFromObject(w))) return true;
            for(let p of pallets) if(p.userData.dropped && pb.intersectsBox(new THREE.Box3().setFromObject(p))) return true;
            return false;
        }

        function forceUnstuck(agent) {
            const dirs = [
                new THREE.Vector3(1,0,0), new THREE.Vector3(-1,0,0), new THREE.Vector3(0,0,1), new THREE.Vector3(0,0,-1),
                new THREE.Vector3(1,0,1), new THREE.Vector3(-1,0,1), new THREE.Vector3(1,0,-1), new THREE.Vector3(-1,0,-1)
            ];
            for(let d of dirs) {
                const t = agent.position.clone().add(d.normalize().multiplyScalar(1.5));
                if(!checkCol(t, agent.userData.role==='hunter')) { agent.position.copy(t); return; }
            }
            setSafePos(agent, 0, 0); // Fallback
        }

        // --- INTERACTIONS ---
        function tryInteract() {
            if(state.isVaulting || state.isAttacking || state.isRecovering) return;
            
            // Pallet
            for(let p of pallets) {
                if(player.position.distanceTo(p.position) < 3.5) {
                    if(config.role === 'survivor') {
                        if(!p.userData.dropped) {
                            p.rotation.z = Math.PI/2; p.position.y=0.5; p.userData.dropped=true;
                            playSound('pallet');
                            // Push player if caught
                            if(checkCol(player.position, false)) {
                                const push = player.position.clone().sub(p.position).normalize().multiplyScalar(2);
                                player.position.add(push);
                            }
                        } else performVault(player, p.position);
                    } else {
                        if(p.userData.dropped) {
                            playSound('action'); state.isBreaking = true;
                            setTimeout(()=>{ scene.remove(p); state.isBreaking = false; }, 1000);
                        }
                    }
                    return;
                }
            }
            // Window
            for(let w of windows) {
                if(player.position.distanceTo(w.position) < 3.0) { performVault(player, w.position); return; }
            }
        }

        function performVault(agent, target) {
            if(agent.userData.isVaulting) return;
            agent.userData.isVaulting = true;
            if(agent === player) state.isVaulting = true;
            playSound('action');
            
            const dir = new THREE.Vector3().subVectors(target, agent.position).normalize(); dir.y=0;
            const start = agent.position.clone();
            const end = target.clone().add(dir.multiplyScalar(3.0));
            let p = 0;
            const iv = setInterval(() => {
                p+=0.1; agent.position.lerpVectors(start, end, p); agent.position.y = Math.sin(p*Math.PI)*1.5;
                if(p>=1) { 
                    clearInterval(iv); agent.position.y=0; 
                    agent.userData.isVaulting=false; 
                    if(agent===player) state.isVaulting=false; 
                }
            }, 30);
        }

        function attack() {
            if(state.isAttacking || state.isRecovering) return;
            state.isAttacking = true;
            
            // Lunge
            const startZ = player.children[0].position.z; 
            player.children[0].position.z += 0.5; 
            
            // Hit check
            let hit = false;
            const fwd = new THREE.Vector3(0,0,1).applyQuaternion(player.quaternion);
            for(let a of aiAgents) {
                if(player.position.distanceTo(a.position) < 4 && fwd.dot(a.position.clone().sub(player.position).normalize()) > 0.5) {
                    playSound('hit'); hit = true;
                    a.userData.hp--;
                    // Effect
                    const f = document.getElementById('flash-overlay');
                    f.style.backgroundColor = 'red'; f.style.opacity = 0.5;
                    setTimeout(()=>f.style.opacity=0, 200);
                    
                    if(a.userData.hp <= 0) {
                        scene.remove(a); a.userData.dot.remove();
                        aiAgents = aiAgents.filter(ag=>ag!==a);
                    } else {
                        // Injured speed burst
                        a.userData.speedBurst = 1.5; setTimeout(()=>a.userData.speedBurst=1, 2000);
                        a.children[0].material.color.setHex(0x550000);
                    }
                }
            }
            
            if(hit) {
                state.isRecovering = true;
                document.getElementById('recover-msg').style.display = 'block';
                setTimeout(() => {
                    state.isRecovering = false;
                    document.getElementById('recover-msg').style.display = 'none';
                }, 2000); // Blade Wipe
            } else {
                playSound('action'); // Miss swing sound
            }

            setTimeout(()=> { player.children[0].position.z = startZ; state.isAttacking=false; }, 800);
        }

        function useSkill() {
            if(state.skillCd > 0) return;
            state.skillCd = 12;
            playSound('action');
            if(config.char === 'mercenary' || config.char === 'clown') {
                const iv = setInterval(()=> {
                    const fwd = new THREE.Vector3(0,0,1).applyQuaternion(player.quaternion);
                    const n = player.position.clone().add(fwd.multiplyScalar(1.2));
                    if(!checkCol(n, config.role==='hunter')) player.position.copy(n);
                }, 20);
                setTimeout(()=>clearInterval(iv), 300);
            } else if (config.char === 'doctor') {
                player.userData.hp = 2; updateHealthUI();
            }
        }

        // --- MAIN LOOP ---
        function animate(time) {
            requestAnimationFrame(animate); renderer.render(scene, camera);
            if(!state.playing) return;
            const dt = (time - state.lastTime)/1000 || 0.016; state.lastTime = time;
            
            // Timer
            state.time -= dt;
            document.getElementById('timer').innerText = Math.ceil(state.time);
            if(state.time <= 0 || (config.role==='hunter' && aiAgents.length===0)) gameOver(config.role==='survivor');

            // Skill CD
            if(state.skillCd > 0) state.skillCd -= dt;

            // Player Move
            if(!state.isVaulting && !state.isAttacking && !state.isRecovering && !state.isBreaking) {
                let speed = (config.role==='hunter'?12:10) * dt * state.speedBuff;
                if((keys['ShiftLeft'] || touchInput.run) && state.stamina > 0) { speed *= 1.5; state.stamina -= 10*dt; }
                
                let ix = 0, iy = 0;
                if(keys['KeyW']) iy += 1; if(keys['KeyS']) iy -= 1;
                if(keys['KeyA']) ix += 1; if(keys['KeyD']) ix -= 1;
                if(touchInput.x !== 0 || touchInput.y !== 0) { ix -= touchInput.x; iy -= touchInput.y; }

                if(ix !== 0 || iy !== 0) {
                    const fwd = new THREE.Vector3(0,0,1).applyQuaternion(player.quaternion);
                    const right = new THREE.Vector3(-1,0,0).applyQuaternion(player.quaternion);
                    const move = new THREE.Vector3().add(fwd.multiplyScalar(iy)).add(right.multiplyScalar(ix)).normalize().multiplyScalar(speed);
                    
                    const next = player.position.clone().add(move);
                    if(!checkCol(next, config.role==='hunter')) player.position.copy(next);
                    else {
                        // Slide
                        const sx = player.position.clone().add(new THREE.Vector3(move.x,0,0));
                        if(!checkCol(sx, config.role==='hunter')) player.position.copy(sx);
                        else {
                            const sz = player.position.clone().add(new THREE.Vector3(0,0,move.z));
                            if(!checkCol(sz, config.role==='hunter')) player.position.copy(sz);
                        }
                    }
                }
            }

            // Camera
            const offset = new THREE.Vector3(0, 5, -6).applyQuaternion(player.quaternion);
            camera.position.lerp(player.position.clone().add(offset), 0.2);
            camera.lookAt(player.position.clone().add(new THREE.Vector3(0,2,0)));

            updateAI(dt); updateUI();
        }

        function updateAI(dt) {
            aiAgents.forEach(a => {
                if(a.userData.isVaulting) return;
                
                // Stuck Check
                if(a.position.distanceTo(a.userData.lastPos) < 0.05) a.userData.stuckTime += dt;
                else a.userData.stuckTime = 0;
                a.userData.lastPos.copy(a.position);
                if(a.userData.stuckTime > 0.5) { forceUnstuck(a); a.userData.stuckTime = 0; a.userData.wander = null; }

                // Basic Logic
                const speed = a.userData.speed * dt * (a.userData.speedBurst || 1);
                const dist = a.position.distanceTo(player.position);
                let dir = new THREE.Vector3();

                if(a.userData.role === 'hunter') {
                    if(a.userData.recovery > 0) { a.userData.recovery -= dt; return; }
                    if(dist < 1.5) {
                        playSound('hit'); 
                        a.userData.recovery = 2.0; 
                        // Player takes damage
                        const f = document.getElementById('flash-overlay');
                        f.style.backgroundColor = 'red'; f.style.opacity = 0.5;
                        setTimeout(()=>f.style.opacity=0, 200);
                        // Game Over Logic if player HP implement
                        gameOver(false); // Immediate game over for now
                        return;
                    }
                    if(dist < 40) { // Chase
                        dir.subVectors(player.position, a.position).normalize();
                        a.lookAt(player.position);
                    }
                } else {
                    if(dist < 20) { // Flee
                        dir.subVectors(a.position, player.position).normalize();
                        a.lookAt(a.position.clone().add(dir));
                    } else { // Wander
                        if(!a.userData.wander || a.position.distanceTo(a.userData.wander) < 1) {
                            a.userData.wander = new THREE.Vector3((Math.random()-0.5)*80, 0, (Math.random()-0.5)*80);
                        }
                        dir.subVectors(a.userData.wander, a.position).normalize();
                        a.lookAt(a.userData.wander);
                    }
                }

                if(dir.length() > 0) {
                    const next = a.position.clone().add(dir.multiplyScalar(speed));
                    if(!checkCol(next, a.userData.role==='hunter')) a.position.copy(next);
                    else {
                        // Slide AI
                        const sx = a.position.clone().add(new THREE.Vector3(dir.x*speed,0,0));
                        if(!checkCol(sx, a.userData.role==='hunter')) a.position.copy(sx);
                        else {
                            const sz = a.position.clone().add(new THREE.Vector3(0,0,dir.z*speed));
                            if(!checkCol(sz, a.userData.role==='hunter')) a.position.copy(sz);
                        }
                    }
                }

                // Minimap update
                if(a.userData.dot) {
                    a.userData.dot.style.left = (a.position.x + 50)*1.3 + 'px';
                    a.userData.dot.style.top = (a.position.z + 50)*1.3 + 'px';
                }
            });
        }

        function updateUI() {
            document.getElementById('stamina-bar').style.width = state.stamina + "%";
            if(state.stamina < 100) state.stamina += 0.05;

            const mmP = document.getElementById('mm-player');
            mmP.style.left = (player.position.x + 50)*1.3 + 'px';
            mmP.style.top = (player.position.z + 50)*1.3 + 'px';
            mmP.style.transform = `translate(-50%, -50%) rotate(${-player.rotation.y * 180/Math.PI}deg)`;

            // Context Button Active State
            let canInteract = false;
            for(let p of pallets) if(player.position.distanceTo(p.position) < 3.5) canInteract = true;
            for(let w of windows) if(player.position.distanceTo(w.position) < 3.0) canInteract = true;
            
            const btnInt = document.getElementById('btn-interact');
            if(canInteract) btnInt.classList.add('active');
            else btnInt.classList.remove('active');
        }

        function updateHealthUI() {
            if(config.role !== 'survivor') { document.getElementById('health-display').style.display = 'none'; return; }
            let s = ""; for(let i=0;i<player.userData.hp;i++) s+="‚ù§Ô∏è";
            document.getElementById('health-display').innerHTML = s;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                if(screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape');
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function selectRole(r, el) {
            config.role = r;
            document.querySelectorAll('.role-card').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            updateCharOptions();
        }

        function updateCharOptions() {
            const grid = document.getElementById('char-options');
            grid.innerHTML = '';
            const list = config.role === 'survivor' 
                ? [{id:'mercenary',name:'‡∏ó‡∏´‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á'}, {id:'doctor',name:'‡∏´‡∏°‡∏≠'}, {id:'thief',name:'‡πÇ‡∏à‡∏£'}]
                : [{id:'ripper',name:'The Ripper'}, {id:'clown',name:'Clown'}];
            list.forEach((c, i) => {
                const b = document.createElement('div'); b.className = `char-btn ${i===0?'selected':''}`; b.innerText = c.name;
                b.onclick = () => { config.char = c.id; document.querySelectorAll('.char-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); };
                if(i===0) config.char = c.id;
                grid.appendChild(b);
            });
        }

        function gameOver(win) {
            state.playing = false;
            document.getElementById('hud').style.display = 'none';
            document.getElementById('game-over').classList.remove('hidden');
            document.querySelector('#game-over h1').innerText = win ? "YOU ESCAPED!" : "GAME OVER";
        }

        window.onload = init;
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
    </script>
</body>
</html>
